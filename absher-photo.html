<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>أدوات الصور – PdfSwift</title>

<!-- الخطوط -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- أيقونات -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- CropperJS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<style>
body {
  font-family: 'Cairo', sans-serif;
  background: #f8fafc;
  margin: 0;
  padding: 0;
  color: #0f172a;
}

/* الهيدر */
header {
  background: #1e293b;
  padding: 1.2rem 2rem;
  color: white;
  text-align: center;
  font-size: 1.4rem;
  font-weight: 700;
}

/* عنوان الصفحة */
.page-title {
  text-align: center;
  margin: 2rem 0 1rem;
  font-size: 2rem;
  font-weight: 700;
  color: #0f172a;
}

/* شبكة الأدوات */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1.2rem;
  padding: 0 1.5rem;
  margin-bottom: 2.5rem;
}

.tool-card {
  background: white;
  padding: 1.5rem;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  cursor: pointer;
  transition: 0.2s;
}

.tool-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 18px rgba(0,0,0,0.1);
}

.tool-card i {
  font-size: 2.5rem;
  color: #1e40af;
  margin-bottom: 0.8rem;
}

.tool-card h3 {
  margin: 0;
  font-size: 1.2rem;
  font-weight: 700;
}

/* مودال */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal {
  background: #ffffff;
  border-radius: 18px;
  max-width: 700px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  padding: 1.8rem 1.8rem 2.2rem;
  box-shadow: 0 20px 50px rgba(15,23,42,0.25);
  position: relative;
}

/* زر الإغلاق */
.close-btn {
  position: absolute;
  top: 12px;
  left: 12px;
  background: none;
  border: none;
  font-size: 1.4rem;
  cursor: pointer;
  color: #475569;
}

/* أزرار */
.action-btn {
  display: inline-block;
  background: #1e40af;
  color: white;
  padding: 0.8rem 1.4rem;
  border-radius: 10px;
  text-decoration: none;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  margin-top: 1rem;
}

.status {
  margin-top: 1rem;
  font-weight: 600;
  color: #1e293b;
}

.status.error {
  color: #dc2626;
}

.status.success {
  color: #16a34a;
}

/* الجوال */
@media (max-width: 900px) {
  .tools-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>

<body>

<header>أدوات الصور – PdfSwift</header>

<h1 class="page-title">اختر أداتك</h1>

<div class="tools-grid">

  <div class="tool-card" onclick="openModal('absher-modal')">
    <i class="fa-solid fa-user"></i>
    <h3>صورة أبشر</h3>
  </div>

  <div class="tool-card" onclick="openModal('remove-bg-modal')">
    <i class="fa-solid fa-image"></i>
    <h3>إزالة الخلفية</h3>
  </div>

  <div class="tool-card" onclick="openModal('enhance-modal')">
    <i class="fa-solid fa-wand-magic-sparkles"></i>
    <h3>تحسين الجودة</h3>
  </div>

  <div class="tool-card" onclick="openModal('compress-modal')">
    <i class="fa-solid fa-compress"></i>
    <h3>ضغط الصور</h3>
  </div>

  <div class="tool-card" onclick="openModal('convert-modal')">
    <i class="fa-solid fa-repeat"></i>
    <h3>تحويل الصيغ</h3>
  </div>

</div>
<!-- ===========================
     مودال صورة أبشر
=========================== -->
<div class="modal-overlay" id="absher-modal">
  <div class="modal">
    <button class="close-btn" onclick="closeModal('absher-modal')">&times;</button>
    <h2>تعديل صورة أبشر</h2>

    <label>ارفع الصورة:</label>
    <input type="file" id="upload-image" accept="image/*">

    <img id="image-preview" style="display:none;max-width:100%;margin-top:1rem;border-radius:10px;">

    <h3 style="margin-top:1.5rem;">الإعدادات:</h3>

    <label>المقاس:</label>
    <select id="preset-size">
      <option value="200x200">200 × 200</option>
      <option value="300x300">300 × 300</option>
      <option value="400x400">400 × 400</option>
      <option value="custom">مخصص</option>
    </select>

    <input type="number" id="custom-width" placeholder="العرض" style="display:none;margin-top:8px;">
    <input type="number" id="custom-height" placeholder="الارتفاع" style="display:none;margin-top:8px;">

    <label style="margin-top:1rem;">الخلفية:</label>
    <select id="background">
      <option value="white">أبيض</option>
      <option value="transparent">شفافة</option>
      <option value="custom">لون مخصص</option>
    </select>

    <input type="color" id="custom-bg" style="display:none;margin-top:8px;">

    <label style="margin-top:1rem;">الحجم الأقصى (KB):</label>
    <input type="number" id="max-size" value="100">

    <label style="margin-top:1rem;">الصيغة:</label>
    <select id="format">
      <option value="jpeg">JPEG</option>
      <option value="png">PNG</option>
    </select>

    <button id="process-btn" class="action-btn">تنفيذ</button>

    <div id="status" class="status"></div>
    <div id="result-preview" style="margin-top:1rem;"></div>
  </div>
</div>

<!-- ===========================
     مودال إزالة الخلفية
=========================== -->
<div class="modal-overlay" id="remove-bg-modal">
  <div class="modal">
    <button class="close-btn" onclick="closeModal('remove-bg-modal')">&times;</button>
    <h2>إزالة الخلفية</h2>

    <label>ارفع الصورة:</label>
    <input type="file" id="remove-bg-input" accept="image/*">

    <button id="remove-bg-btn" class="action-btn">تنفيذ</button>

    <div id="remove-bg-status" class="status"></div>
    <div id="remove-bg-preview" style="margin-top:1rem;"></div>
  </div>
</div>

<!-- ===========================
     مودال تحسين الجودة
=========================== -->
<div class="modal-overlay" id="enhance-modal">
  <div class="modal">
    <button class="close-btn" onclick="closeModal('enhance-modal')">&times;</button>
    <h2>تحسين جودة الصورة</h2>

    <label>ارفع الصورة:</label>
    <input type="file" id="enhance-input" accept="image/*">

    <button id="enhance-btn" class="action-btn">تنفيذ</button>

    <div id="enhance-status" class="status"></div>
    <div id="enhance-preview" style="margin-top:1rem;"></div>
  </div>
</div>

<!-- ===========================
     مودال ضغط الصور
=========================== -->
<div class="modal-overlay" id="compress-modal">
  <div class="modal">
    <button class="close-btn" onclick="closeModal('compress-modal')">&times;</button>
    <h2>ضغط الصور</h2>

    <label>ارفع الصورة:</label>
    <input type="file" id="compress-input" accept="image/*">

    <label style="margin-top:1rem;">الحجم المطلوب (KB):</label>
    <input type="number" id="compress-size" value="200">

    <button id="compress-btn" class="action-btn">تنفيذ</button>

    <div id="compress-status" class="status"></div>
    <div id="compress-preview" style="margin-top:1rem;"></div>
  </div>
</div>

<!-- ===========================
     مودال تحويل الصيغ
=========================== -->
<div class="modal-overlay" id="convert-modal">
  <div class="modal">
    <button class="close-btn" onclick="closeModal('convert-modal')">&times;</button>
    <h2>تحويل صيغة الصورة</h2>

    <label>ارفع الصورة:</label>
    <input type="file" id="convert-input" accept="image/*">

    <label style="margin-top:1rem;">الصيغة المطلوبة:</label>
    <select id="convert-format">
      <option value="jpeg">JPEG</option>
      <option value="png">PNG</option>
      <option value="webp">WEBP</option>
    </select>

    <button id="convert-btn" class="action-btn">تنفيذ</button>

    <div id="convert-status" class="status"></div>
    <div id="convert-preview" style="margin-top:1rem;"></div>
  </div>
</div>
<!-- مكتبات خارجية -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<script>
/* ============================================================
   تحميل نماذج face-api
============================================================ */
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/models"),
]).then(() => console.log("Face API Loaded"));

let cropper = null;

/* ============================================================
   فتح / إغلاق المودال
============================================================ */
function openModal(id) {
  const modal = document.getElementById(id);
  modal.style.display = "flex";

  if (id === "absher-modal") {
    const img = document.getElementById("image-preview");
    if (img.src && img.style.display !== "none") {
      setTimeout(() => {
        if (cropper) cropper.destroy();
        cropper = new Cropper(img, {
          viewMode: 1,
          aspectRatio: 1,
          autoCropArea: 1,
          movable: true,
          zoomable: true,
          scalable: true,
          rotatable: true,
          background: false,
        });
        detectFace();
      }, 200);
    }
  }
}

function closeModal(id) {
  document.getElementById(id).style.display = "none";
}

/* ============================================================
   رفع صورة أبشر
============================================================ */
document.getElementById("upload-image").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const img = document.getElementById("image-preview");
  img.src = URL.createObjectURL(file);
  img.style.display = "block";

  if (cropper) cropper.destroy();

  setTimeout(() => {
    cropper = new Cropper(img, {
      viewMode: 1,
      aspectRatio: 1,
      autoCropArea: 1,
      movable: true,
      zoomable: true,
      scalable: true,
      rotatable: true,
      background: false,
    });
    detectFace();
  }, 200);
});

/* ============================================================
   كشف الوجه تلقائيًا
============================================================ */
async function detectFace() {
  const img = document.getElementById("image-preview");
  if (!img.src) return;

  try {
    const detection = await faceapi.detectSingleFace(
      img,
      new faceapi.TinyFaceDetectorOptions()
    );

    if (!detection || !cropper) return;

    const box = detection.box;

    cropper.setCropBoxData({
      left: box.x,
      top: box.y,
      width: box.width,
      height: box.height,
    });
  } catch (e) {
    console.warn("Face detection error:", e);
  }
}

/* ============================================================
   المقاس المخصص
============================================================ */
document.getElementById("preset-size").addEventListener("change", function () {
  const custom = this.value === "custom";
  document.getElementById("custom-width").style.display = custom ? "block" : "none";
  document.getElementById("custom-height").style.display = custom ? "block" : "none";
});

/* ============================================================
   لون الخلفية
============================================================ */
document.getElementById("background").addEventListener("change", function () {
  document.getElementById("custom-bg").style.display =
    this.value === "custom" ? "block" : "none";
});

/* ============================================================
   زر تنفيذ أداة أبشر
============================================================ */
document.getElementById("process-btn").addEventListener("click", async () => {
  const status = document.getElementById("status");
  status.textContent = "جاري معالجة الصورة...";
  status.className = "status";

  if (!cropper) {
    status.textContent = "الرجاء رفع صورة أولاً";
    status.className = "status error";
    return;
  }

  let width, height;
  const preset = document.getElementById("preset-size").value;

  if (preset === "custom") {
    width = parseInt(document.getElementById("custom-width").value);
    height = parseInt(document.getElementById("custom-height").value);
  } else {
    const [w, h] = preset.split("x");
    width = parseInt(w);
    height = parseInt(h);
  }

  let bg = "white";
  const bgType = document.getElementById("background").value;
  if (bgType === "transparent") bg = null;
  if (bgType === "custom") bg = document.getElementById("custom-bg").value;

  const maxKB = parseInt(document.getElementById("max-size").value);
  const format = document.getElementById("format").value;

  const canvas = cropper.getCroppedCanvas({
    width,
    height,
    fillColor: bg || "white",
  });

  let quality = 0.92;
  let output;

  try {
    do {
      output = canvas.toDataURL(`image/${format}`, quality);
      const sizeKB = Math.round((output.length * 3) / 4 / 1024);
      if (sizeKB <= maxKB) break;
      quality -= 0.05;
    } while (quality > 0.1);

    document.getElementById("result-preview").innerHTML = `
      <h3>الصورة النهائية:</h3>
      <img src="${output}">
      <br><br>
      <a href="${output}" download="absher-photo.${format}" class="action-btn">تحميل الصورة</a>
    `;

    status.textContent = "تم تجهيز الصورة ✔️";
    status.className = "status success";
  } catch (e) {
    console.error(e);
    status.textContent = "حدث خطأ أثناء المعالجة";
    status.className = "status error";
  }
});

/* ============================================================
   إزالة الخلفية
============================================================ */
document.getElementById("remove-bg-btn").addEventListener("click", async () => {
  const file = document.getElementById("remove-bg-input").files[0];
  const status = document.getElementById("remove-bg-status");
  const preview = document.getElementById("remove-bg-preview");

  if (!file) {
    status.textContent = "الرجاء اختيار صورة";
    status.className = "status error";
    return;
  }

  status.textContent = "جاري إزالة الخلفية...";
  status.className = "status";

  try {
    const img = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    for (let i = 0; i < data.length; i += 4) {
      if (data[i] > 240 && data[i + 1] > 240 && data[i + 2] > 240) {
        data[i + 3] = 0;
      }
    }

    ctx.putImageData(imageData, 0, 0);

    const output = canvas.toDataURL("image/png");

    preview.innerHTML = `
      <img src="${output}">
      <br><br>
      <a href="${output}" download="no-bg.png" class="action-btn">تحميل الصورة</a>
    `;

    status.textContent = "تمت إزالة الخلفية ✔️";
    status.className = "status success";
  } catch (e) {
    console.error(e);
    status.textContent = "حدث خطأ أثناء إزالة الخلفية";
    status.className = "status error";
  }
});

/* ============================================================
   تحسين الجودة
============================================================ */
document.getElementById("enhance-btn").addEventListener("click", async () => {
  const file = document.getElementById("enhance-input").files[0];
  const status = document.getElementById("enhance-status");
  const preview = document.getElementById("enhance-preview");

  if (!file) {
    status.textContent = "الرجاء اختيار صورة";
    status.className = "status error";
    return;
  }

  status.textContent = "جاري تحسين الجودة...";
  status.className = "status";

  try {
    const img = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");

    ctx.filter = "contrast(115%) brightness(110%) saturate(120%)";
    ctx.drawImage(img, 0, 0);

    const output = canvas.toDataURL("image/jpeg", 0.92);

    preview.innerHTML = `
      <img src="${output}">
      <br><br>
      <a href="${output}" download="enhanced.jpg" class="action-btn">تحميل الصورة</a>
    `;

    status.textContent = "تم تحسين الجودة ✔️";
    status.className = "status success";
  } catch (e) {
    console.error(e);
    status.textContent = "حدث خطأ أثناء تحسين الجودة";
    status.className = "status error";
  }
});

/* ============================================================
   ضغط الصور
============================================================ */
document.getElementById("compress-btn").addEventListener("click", async () => {
  const file = document.getElementById("compress-input").files[0];
  const maxKB = parseInt(document.getElementById("compress-size").value);
  const status = document.getElementById("compress-status");
  const preview = document.getElementById("compress-preview");

  if (!file) {
    status.textContent = "الرجاء اختيار صورة";
    status.className = "status error";
    return;
  }

  status.textContent = "جاري الضغط...";
  status.className = "status";

  try {
    const img = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);

    let quality = 0.92;
    let output;

    do {
      output = canvas.toDataURL("image/jpeg", quality);
      const sizeKB = Math.round((output.length * 3) / 4 / 1024);
      if (sizeKB <= maxKB) break;
      quality -= 0.05;
    } while (quality > 0.1);

    preview.innerHTML = `
      <img src="${output}">
      <br><br>
      <a href="${output}" download="compressed.jpg" class="action-btn">تحميل الصورة</a>
    `;

    status.textContent = "تم ضغط الصورة ✔️";
    status.className = "status success";
  } catch (e) {
    console.error(e);
    status.textContent = "حدث خطأ أثناء الضغط";
    status.className = "status error";
  }
});

/* ============================================================
   تحويل الصيغ
============================================================ */
document.getElementById("convert-btn").addEventListener("click", async () => {
  const file = document.getElementById("convert-input").files[0];
  const format = document.getElementById("convert-format").value;
  const status = document.getElementById("convert-status");
  const preview = document.getElementById("convert-preview");

  if (!file) {
    status.textContent = "الرجاء اختيار صورة";
    status.className = "status error";
    return;
  }

  status.textContent = "جاري التحويل...";
  status.className = "status";

  try {
    const img = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);

    const output = canvas.toDataURL(`image/${format}`, 0.92);

    preview.innerHTML = `
      <img src="${output}">
      <br><br>
      <a href="${output}" download="converted.${format}" class="action-btn">تحميل الصورة</a>
    `;

    status.textContent = "تم تحويل الصورة ✔️";
    status.className = "status success";
  } catch (e) {
    console.error(e);
    status.textContent = "حدث خطأ أثناء التحويل";
    status.className = "status error";
  }
});
</script>

</body>
</html>
